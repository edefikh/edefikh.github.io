Setting up AWS infrastructure for a healthcare-related app that must be CMMC 2.0 ready requires a secure and compliant architecture. Below is a Terraform script that implements a three-tier architecture with Kubernetes (EKS), RDS, security tools, monitoring, and logging while following security best practices.

Key Components:
VPC & Networking: Multi-AZ deployment, private/public subnets, NAT Gateway, security groups, and IAM roles.
Compute (EKS - Kubernetes): Amazon Elastic Kubernetes Service (EKS) for containerized workloads.
Database (RDS): PostgreSQL with encryption, backups, and multi-AZ failover.
Security & Compliance:
AWS Security Hub for continuous compliance checks.
AWS GuardDuty for threat detection.
AWS Config for resource monitoring and compliance enforcement.
IAM Roles & Policies with least privilege.
AWS WAF for application-layer protection.
AWS Shield for DDoS protection.
Monitoring & Logging:
Amazon CloudWatch for logs, metrics, and alarms.
AWS CloudTrail for auditing API calls.
Amazon OpenSearch (Elasticsearch) for centralized log analysis.

Terraform Script:

provider "aws" {
  region = "us-east-1"
}

# -----------------------------------------------
# VPC and Networking
# -----------------------------------------------
module "vpc" {
  source          = "terraform-aws-modules/vpc/aws"
  name           = "secure-vpc"
  cidr           = "10.0.0.0/16"
  azs            = ["us-east-1a", "us-east-1b"]
  private_subnets = ["10.0.1.0/24", "10.0.2.0/24"]
  public_subnets  = ["10.0.101.0/24", "10.0.102.0/24"]
  enable_nat_gateway = true
  enable_dns_hostnames = true
}

# -----------------------------------------------
# AWS KMS for Encryption (HIPAA Requirement)
# -----------------------------------------------
resource "aws_kms_key" "cmk" {
  description             = "HIPAA-Compliant Encryption Key"
  enable_key_rotation     = true
}

resource "aws_kms_alias" "cmk_alias" {
  name          = "alias/hipaa-compliant-key"
  target_key_id = aws_kms_key.cmk.id
}

# -----------------------------------------------
# EKS Cluster (Kubernetes) - HIPAA Secure
# -----------------------------------------------
module "eks" {
  source          = "terraform-aws-modules/eks/aws"
  cluster_name    = "secure-eks-cluster"
  cluster_version = "1.29"
  subnets         = module.vpc.private_subnets
  vpc_id          = module.vpc.vpc_id
  enable_irsa     = true  # Enable IAM Roles for Service Accounts

  node_groups = {
    workers = {
      desired_capacity = 3
      max_capacity     = 5
      min_capacity     = 2
      instance_types   = ["t3.medium"]
      key_name         = "eks-key"
      additional_tags = {
        "HIPAA" = "Compliant"
      }
    }
  }
}

# -----------------------------------------------
# RDS (PostgreSQL) - Encrypted, Secure, Multi-AZ
# -----------------------------------------------
module "rds" {
  source             = "terraform-aws-modules/rds/aws"
  identifier         = "secure-db"
  engine            = "postgres"
  engine_version    = "15.2"
  instance_class    = "db.t3.medium"
  allocated_storage = 100
  db_name           = "securedb"
  username         = "admin"
  password         = "SuperSecurePass123!"
  multi_az         = true
  publicly_accessible = false
  storage_encrypted = true
  kms_key_id        = aws_kms_key.cmk.id
  deletion_protection = true
  backup_retention_period = 14
  subnet_ids       = module.vpc.private_subnets
}

# -----------------------------------------------
# Security: IAM, GuardDuty, Security Hub, WAF, Shield, Macie
# -----------------------------------------------
resource "aws_guardduty_detector" "gd" {
  enable = true
}

resource "aws_securityhub_account" "sh" {}

resource "aws_macie2_account" "macie" {
  status = "ENABLED"
}

resource "aws_config_configuration_recorder" "config" {
  name     = "default"
  role_arn = aws_iam_role.config_role.arn
}

resource "aws_waf_web_acl" "waf" {
  name        = "secure-waf"
  metric_name = "SecureWAF"
  default_action {
    allow {}
  }
  rule {
    name     = "block-bad-ips"
    priority = 1
    action {
      block {}
    }
    visibility_config {
      cloudwatch_metrics_enabled = true
      metric_name                = "block-bad-ips"
      sampled_requests_enabled   = true
    }
  }
}

# -----------------------------------------------
# Monitoring & Logging: CloudTrail, CloudWatch, OpenSearch
# -----------------------------------------------
resource "aws_cloudwatch_log_group" "eks_logs" {
  name = "/aws/eks/secure-logs"
  retention_in_days = 30
}

resource "aws_cloudtrail" "cloudtrail" {
  name                          = "secure-cloudtrail"
  s3_bucket_name                = aws_s3_bucket.cloudtrail_bucket.id
  is_multi_region_trail         = true
  include_global_service_events = true
  kms_key_id                    = aws_kms_key.cmk.id
}

resource "aws_s3_bucket" "cloudtrail_bucket" {
  bucket = "secure-cloudtrail-logs"
  lifecycle {
    prevent_destroy = true
  }
}

resource "aws_s3_bucket_versioning" "versioning" {
  bucket = aws_s3_bucket.cloudtrail_bucket.id
  versioning_configuration {
    status = "Enabled"
  }
}

resource "aws_elasticsearch_domain" "es" {
  domain_name           = "secure-logs"
  elasticsearch_version = "7.10"
  cluster_config {
    instance_type = "t3.small.elasticsearch"
  }
  ebs_options {
    ebs_enabled = true
    volume_size = 20
  }
}

# -----------------------------------------------
# Output Values
# -----------------------------------------------
output "eks_cluster_name" {
  value = module.eks.cluster_id
}

output "rds_endpoint" {
  value = module.rds.db_instance_endpoint
}

output "vpc_id" {
  value = module.vpc.vpc_id
}



Next Steps
Run Terraform

sh
terraform init
terraform apply


Integrate Kubernetes Workloads
Deploy application workloads on EKS.
Use Kubernetes Network Policies for better isolation.
Implement a service mesh like Istio for security.
Implement CI/CD
Use AWS CodePipeline or GitHub Actions for deployments.
Harden Security Further
Implement AWS KMS CMK for advanced encryption.
Use AWS Systems Manager Parameter Store for secrets management.
